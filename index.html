<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove the app! (Instant Play)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.min.js"></script>
    <style>
        /* CSS Variables for Dynamic Background Control */
        :root {
            --bg-hue: 220; 
            --bg-saturation: 20%;
            --bg-lightness: 8%;
        }
        
        /* 1. Body tam ekranı kaplamalı */
        body {
            width: 100vw; 
            height: 100vh;
            margin: 0;
            padding: 0;
            
            /* HSL used for dynamic hue cycling */
            background: radial-gradient(circle at center, 
                hsl(var(--bg-hue), var(--bg-saturation), 10%) 0%, 
                #000000 100%);
            transition: background 0.5s ease-out; 
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Mobil gecikmeleri engeller */
        }

        /* 2. Ana düzenleyici (main-content) yüksekliği yönetmeli */
        .main-content {
             display: flex;
             flex-direction: column;
             height: 100%; /* Body'nin 100vh'ini kullan */
             width: 100%;
             padding-top: 1rem; /* pt-4 */
             padding-bottom: 1rem; /* pb-4 */
             box-sizing: border-box; /* Padding dahil boyutu hesapla */
        }

        #gameCanvas {
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.2), 0 0 10px rgba(0, 255, 255, 0.4);
            border: 2px solid #00FFFF;
            transition: box-shadow 0.3s ease-out;
            cursor: pointer; 
            /* Mobil ekranlarda daha iyi sığması için max genişlikleri kaldırıyoruz, JS yönetecek */
        }
        .flow-active-shadow {
            box-shadow: 0 0 100px hsla(var(--bg-hue), 100%, 70%, 0.9), 0 0 30px hsla(var(--bg-hue), 100%, 80%, 1);
            border: 3px solid hsla(var(--bg-hue), 100%, 80%, 1) !important;
        }
        .full-screen-container {
             flex-grow: 1; 
             display: flex;
             align-items: center;
             justify-content: center;
             width: 100%;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Consolas', 'Monaco', 'monospace'],
                    },
                }
            }
        }
    </script>
</head>
<body class="overflow-hidden text-gray-100"> 

    <div class="main-content flex items-center justify-start"> 

        <div class="text-4xl font-extrabold mb-4 tracking-widest text-red-400 mx-auto">
            <span class="text-gray-500">REMOVE </span><span class="text-red-500">THE APP!</span>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-4 p-4 bg-gray-900/70 backdrop-blur-md rounded-2xl shadow-2xl border border-cyan-800/50 w-full max-w-lg mx-auto">
            <div class="text-sm font-medium text-center border-b border-gray-700/50 pb-1">
                Score: <span id="score" class="text-yellow-300 font-extrabold text-xl font-mono">0</span>
            </div>
            <div class="text-sm font-medium text-center border-b border-gray-700/50 pb-1">
                Multiplier: <span id="multiplier" class="text-orange-400 font-extrabold text-xl font-mono">1</span>x
            </div>
            <div class="text-sm font-medium text-center border-b border-gray-700/50 pb-1">
                High: <span id="highScore" class="text-green-400 font-extrabold text-xl font-mono">0</span>
            </div>
            <div id="statusMessage" class="col-span-3 text-sm font-medium text-center border-b border-gray-700/50 pb-1 text-gray-400 transition duration-300">
                Waiting...
            </div>
        </div>
        
        <div id="canvasContainer" class="full-screen-container">
            <canvas id="gameCanvas" class="rounded-xl"></canvas>
        </div>

        <div class="mt-4 text-sm text-gray-500 mx-auto">
            <span class="font-bold text-yellow-400">Tip:</span> Jump power is proportional to your press duration.
        </div>
        
    </div> <script>
        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const multiplierEl = document.getElementById('multiplier'); 
        const highScoreEl = document.getElementById('highScore');
        const statusMessageEl = document.getElementById('statusMessage');
        const canvasContainer = document.getElementById('canvasContainer'); // Yeni kapsayıcı

        // --- GAME SETTINGS ---
        const ORB_RADIUS = 15;
        const GRAVITY = 0.4;
        
        // --- PROPORTIONAL INPUT SETTINGS ---
        const MIN_LIFT = -3;   
        const MAX_LIFT = -13;  
        const MIN_DURATION_MS = 30; 
        const MAX_DURATION_MS = 200; 
        let pressStartTime = 0; 
        let isPressing = false; 

        // --- FLOW ZONE SETTINGS ---
        const BASE_ZONE_HEIGHT = 150;
        const MIN_ZONE_HEIGHT = 40; 
        const BASE_ZONE_SPEED = 0.03;
        const MAX_ZONE_SPEED = 0.08; 
        const ZONE_AMPLITUDE = 150;
        const COMBO_COLOR_CYCLE = 200; 
        const TIME_TICK_MS = 1000; 

        // --- GAME OBJECTS AND STATE ---
        let orb = { x: 0, y: 0, radius: ORB_RADIUS, velocityY: 0 };
        let flowZone = { y: 0, height: BASE_ZONE_HEIGHT, speed: BASE_ZONE_SPEED, time: 0 };
        let score = 0;
        let combo = 0;
        let isInFlow = false;
        let isAudioReady = false;
        let animationFrameId;
        let comboFlashRadius1 = 0; 
        let comboFlashRadius2 = 0; 

        // --- SCORING STATE ---
        let flowDurationMs = 0; 
        let scoreMultiplier = 1;

        // --- LOKAL YÜKSEK SKOR (LocalStorage) ---
        let highScore = 0;
        const LOCAL_HIGH_SCORE_KEY = 'flowGameHighScore'; 
        
        // --- TONE.JS AUDIO OBJECTS ---
        let flowPad, missEffect, pressFeedback;
        let currentFlowNote = 'C4'; 

        // --- Timing Variables for accurate scoring ---
        let lastTimestamp = performance.now();


        // =================================================================
        //                 AUDIO (TONE.JS) INTEGRATION
        // =================================================================

        function setupAudio() {
            if (typeof Tone === 'undefined') {
                return;
            }

            // ... (Tone.js ayarları aynı kaldı)
            flowPad = new Tone.Synth({
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.5, decay: 0.1, sustain: 1.0, release: 0.5 },
                volume: -15, 
            }).toDestination();
            
            missEffect = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 3,
                envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.5 },
                volume: -8
            }).toDestination();

            pressFeedback = new Tone.PluckSynth({
                attackNoise: 1,
                dampening: 2000,
                resonance: 0.9,
                volume: 0, 
            }).toDestination();

            isAudioReady = true;
        }

        async function startAudioContext() {
            // Ses bağlamını başlatmayı deniyoruz. 
            // Eğer mobil cihazda kullanıcı etkileşimi yoksa, bu kısım hata vermez
            // ama ses başlamaz. Ancak oyunun çalışmasını engellemez.
            if (Tone.context.state !== 'running') {
                try {
                    await Tone.start();
                } catch (e) {
                    console.warn("AudioContext could not start automatically. User interaction needed on mobile.", e);
                }
            }
        }

        // =================================================================
        //                 LOKAL SKOR KAYIT/YÜKLEME (LocalStorage)
        // =================================================================

        function loadHighScore() {
            try {
                const storedScore = localStorage.getItem(LOCAL_HIGH_SCORE_KEY);
                highScore = storedScore ? parseInt(storedScore, 10) : 0;
            } catch (error) {
                console.error("Local High score could not be loaded:", error);
                highScore = 0;
            }
            highScoreEl.textContent = highScore.toLocaleString();
        }

        function saveHighScore(newScore) {
            if (newScore <= highScore) return;

            try {
                localStorage.setItem(LOCAL_HIGH_SCORE_KEY, newScore);
                highScore = newScore;

                highScoreEl.textContent = highScore.toLocaleString();
                statusMessageEl.textContent = 'NEW RECORD!';
                statusMessageEl.classList.remove('text-red-400', 'text-gray-400', 'text-cyan-400');
                statusMessageEl.classList.add('text-green-400', 'font-bold');

            } catch (error) {
                console.error("Local High score could not be saved:", error);
            }
        }

        function checkAndSaveScore() {
            if (score > highScore) {
                saveHighScore(score);
            }
        }

        // =================================================================
        //                 PROPORTIONAL INPUT LOGIC
        // =================================================================

        // Fonksiyonlar aynı kaldı...

        function handlePressStart(e) {
            // ... (Kod aynı)
             if (!animationFrameId) return; 
            if (isPressing) return;
            
            // Eğer AudioContext başlamadıysa, ilk tıklamayı ses bağlamını başlatmak için kullan
            if (Tone.context.state !== 'running') {
                startAudioContext();
            }

            if (e.code === 'Space' || e.type === 'touchstart' || e.type === 'mousedown') {
                isPressing = true;
                pressStartTime = performance.now();
                e.preventDefault(); 
            }
        }

        function handlePressEnd(e) {
            // ... (Kod aynı)
            if (!animationFrameId || !isPressing) return;
            
            if (e.code === 'Space' || e.type === 'touchend' || e.type === 'mouseup') {
                const pressDuration = performance.now() - pressStartTime;

                let durationFactor = Math.min(1, 
                    Math.max(0, 
                        (pressDuration - MIN_DURATION_MS) / (MAX_DURATION_MS - MIN_DURATION_MS)
                    )
                );

                const liftForce = MIN_LIFT + durationFactor * (MAX_LIFT - MIN_LIFT);

                orb.velocityY = liftForce;

                isPressing = false;
                e.preventDefault(); 
                
                // Instant feedback sound
                if (isAudioReady && Tone.context.state === 'running') { // Sadece ses açıksa çal
                    pressFeedback.triggerAttackRelease("G6", "64n"); 
                }

                if (liftForce < MIN_LIFT) {
                    navigator.vibrate?.(50);
                }
            }
        }


        // --- GAME LOOP, UPDATE, AND DRAW CODE ---

        function resizeCanvas() {
            // Yeni kapsayıcıdan boyutları al
            const containerRect = canvasContainer.getBoundingClientRect();
            
            // Canvas'ı biraz daha agresif bir şekilde boyutlandırıyoruz
            // Mobil cihazlarda tam ekranı daha iyi kullanmak için padding'i küçült
            const padding = 10; 
            const containerWidth = containerRect.width - padding * 2;
            const containerHeight = containerRect.height - padding * 2;
            
            const aspectRatio = 400 / 600; // Oyunun hedef oranı (2:3)
            
            let maxWidth = containerWidth;
            let maxHeight = containerHeight;
            
            // Oran koruma: Yatayda mı dikeyde mi daha çok yer var?
            if (maxWidth / maxHeight > aspectRatio) {
                // Konteyner daha geniş (yatayda bol yer var), yüksekliği ana al
                maxWidth = maxHeight * aspectRatio;
            } else {
                // Konteyner daha dar (dikeyde bol yer var), genişliği ana al
                maxHeight = maxWidth / aspectRatio;
            }
            
            // Boyutları ayarla (tam sayı yap)
            canvas.width = Math.floor(maxWidth);
            canvas.height = Math.floor(maxHeight);

            // Orb pozisyonunu merkeze çek
            orb.x = canvas.width / 2;
            orb.y = canvas.height - 50;
        }

        function startGame() {
            // Artık bu direkt window.onload'da çağrılacak. Ses başlangıcını kaldırdık.
            if (!animationFrameId) {
                lastTimestamp = performance.now(); 
                gameLoop();
                statusMessageEl.textContent = 'CATCH THE RHYTHM!';
            }
        }

        // update ve draw fonksiyonları aynı kaldı... (performans ve skor mantığı)

        function update() {
            // ... (Kod aynı)
            const currentTimestamp = performance.now();
            const deltaTime = currentTimestamp - lastTimestamp;
            lastTimestamp = currentTimestamp;

            // 1. Orb Physics
            orb.velocityY += GRAVITY;
            orb.y += orb.velocityY;
            // ... (Kalan update mantığı aynı)
            
            // 4. "FLOW" CHECK (Ses sadece Tone.context.state === 'running' ise çalınmalı)
            // ...
             if (topOfOrb >= topOfZone && bottomOfOrb <= bottomOfZone) {
                // IN FLOW
                if (!isInFlow) {
                    // ... (Görsel ve skor mantığı)
                    if(isAudioReady && Tone.context.state === 'running') flowPad.triggerAttack(currentFlowNote); 

                    // ...
                }
                // ... (Kalan IN FLOW mantığı)
            } else {
                // OUT OF FLOW
                if (isInFlow) {
                    // ... (Görsel ve skor mantığı)
                    if(isAudioReady && Tone.context.state === 'running') {
                        flowPad.triggerRelease();
                        missEffect.triggerAttackRelease("C2", "8n"); 
                    }
                    // ... (Kalan OUT OF FLOW mantığı)
                }
            }

            // ... (UI Güncelleme)
            scoreEl.textContent = Math.floor(score).toLocaleString();
            multiplierEl.textContent = scoreMultiplier; 
        }

        function draw() {
             // ... (Kod aynı)
             // Canvas çizim mantığı aynı kalacak
        }

        // =================================================================
        //                       INITIALIZATION AND EVENT LISTENERS
        // =================================================================

        window.onload = function() {
            loadHighScore(); 
            setupAudio();
            resizeCanvas();
            
            // OYUN DİREKT BAŞLIYOR!
            startGame(); 

            // Klavye/Fare/Dokunmatik olay dinleyicileri
            // İlk etkileşimde ses bağlamını başlatma (handlePressStart'a eklendi)
            window.addEventListener('keydown', handlePressStart);
            window.addEventListener('keyup', handlePressEnd);

            canvas.addEventListener('mousedown', handlePressStart);
            window.addEventListener('mouseup', handlePressEnd);
            
            canvas.addEventListener('touchstart', handlePressStart);
            window.addEventListener('touchend', handlePressEnd);

            window.addEventListener('resize', resizeCanvas);
        };

    </script>
</body>
</html>
